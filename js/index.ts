interface Avatar {
  emoji: string;
  background: Color;
}

interface Color {
  r: number;
  g: number;
  b: number;
}

export enum Usage {
  Any = "any",
  Identity = "identity",
}

const fnv1aHash = (input: string) => {
  const FNV_OFFSET_BASIS = BigInt("14695981039346656037");
  const FNV_PRIME = BigInt("1099511628211");

  const bytes = Buffer.from(input, "utf8");
  let hash = FNV_OFFSET_BASIS;

  for (const byte of bytes) {
    hash ^= BigInt(byte);
    hash = BigInt.asUintN(64, hash * FNV_PRIME);
  }

  return hash;
};

const generateEmoji = (input: string, usage: Usage) => {
  const hashedInput = fnv1aHash(input);

  switch (usage) {
    case Usage.Identity:
      const index = hashedInput % BigInt(EMOJIS.length + EMOJIS_USER.length);

      if (EMOJIS[Number(index)] !== undefined) {
        return EMOJIS[Number(index)];
      } else {
        return EMOJIS_USER[Number(index - BigInt(EMOJIS.length))];
      }
    case Usage.Any:
      return EMOJIS[Number(hashedInput % BigInt(EMOJIS.length))];
  }
};

const generateColor = (input: string) => {
  const hashedInput = fnv1aHash(input);
  const h = Number(hashedInput >> BigInt(40));

  return {
    r: h & 0x0000ff,
    g: (h & 0x00ff00) >> 8,
    b: (h & 0xff0000) >> 16,
  };
};

const compressColor = (color: Color) => {
  const l = lightness(color);

  if (l < 0.5) {
    return lighten(color, 0.125 * (1.0 - l));
  } else {
    return lighten(color, 0.125 * -l);
  }
};

const lightness = (color: Color) => {
  return (color.r / 255.0 + color.g / 255.0 + color.b / 255.0) / 3.0;
};

const lighten = (color: Color, amount: number) => {
  amount = Math.max(amount, -1.0);
  amount = Math.min(amount, 1.0);

  let x = Math.floor(Math.abs(amount) * 255.0);

  if (amount >= 0.0) {
    const r = Math.min(color.r + x, 255);
    const g = Math.min(color.g + x, 255);
    const b = Math.min(color.b + x, 255);

    return { r, g, b };
  } else {
    const r = Math.max(color.r - x, 0);
    const g = Math.max(color.g - x, 0);
    const b = Math.max(color.b - x, 0);

    return { r, g, b };
  }
};

const generateAvatar = (input: string, usage: Usage): Avatar => {
  return {
    emoji: generateEmoji(input, usage),
    background: compressColor(generateColor(input)),
  };
};

export const generate = generateAvatar;

export const __test__ = {
  fnv1aHash,
  generateEmoji,
  generateColor,
  compressColor,
  lightness,
  lighten,
};

const EMOJIS = [
  "ğŸ‘Š",
  "âœŒï¸",
  "ğŸ¤˜",
  "ğŸ‘Œ",
  "ğŸ‘‹",
  "ğŸ‘€",
  "ğŸ§ ",
  "ğŸ§¶",
  "ğŸ§µ",
  "ğŸ‘ ",
  "ğŸ¥¾",
  "ğŸ§¤",
  "ğŸ§£",
  "ğŸ©",
  "ğŸ§¢",
  "ğŸ“",
  "â›‘",
  "ğŸ‘‘",
  "ğŸ‘œ",
  "ğŸ’¼",
  "ğŸ’",
  "ğŸ§³",
  "ğŸ‘“",
  "ğŸ•¶",
  "ğŸ¥½",
  "ğŸŒ‚",
  "ğŸ›º",
  "ğŸª‚",
  "ğŸª",
  "ğŸ¤¿",
  "ğŸª€",
  "ğŸª",
  "ğŸª•",
  "ğŸª”",
  "ğŸª“",
  "ğŸª‘",
  "ğŸª’",
  "ğŸ£",
  "ğŸ¥",
  "ğŸ¦†",
  "ğŸ¦¢",
  "ğŸ¦‰",
  "ğŸ¦š",
  "ğŸ¦œ",
  "ğŸ¦‡",
  "ğŸº",
  "ğŸ—",
  "ğŸ´",
  "ğŸ¦„",
  "ğŸ",
  "ğŸ›",
  "ğŸ¦‹",
  "ğŸŒ",
  "ğŸš",
  "ğŸ",
  "ğŸœ",
  "ğŸ¦—",
  "ğŸ•·",
  "ğŸ¦‚",
  "ğŸ¦Ÿ",
  "ğŸ¦ ",
  "ğŸ¢",
  "ğŸ",
  "ğŸ¦",
  "ğŸ¦–",
  "ğŸ¦•",
  "ğŸ™",
  "ğŸ¦‘",
  "ğŸ¦",
  "ğŸ¦€",
  "ğŸ¡",
  "ğŸ ",
  "ğŸŸ",
  "ğŸ¬",
  "ğŸ³",
  "ğŸ‹",
  "ğŸ¦ˆ",
  "ğŸŠ",
  "ğŸ…",
  "ğŸ†",
  "ğŸ¦“",
  "ğŸ¦",
  "ğŸ˜",
  "ğŸ¦",
  "ğŸª",
  "ğŸ«",
  "ğŸ¦™",
  "ğŸ¦’",
  "ğŸƒ",
  "ğŸ‚",
  "ğŸ„",
  "ğŸ",
  "ğŸ–",
  "ğŸ",
  "ğŸ‘",
  "ğŸ",
  "ğŸ¦Œ",
  "ğŸ•",
  "ğŸ©",
  "ğŸˆ",
  "ğŸ“",
  "ğŸ¦ƒ",
  "ğŸ•Š",
  "ğŸ‡",
  "ğŸ",
  "ğŸ€",
  "ğŸ¿",
  "ğŸ¦”",
  "ğŸ¦§",
  "ğŸ¦®",
  "ğŸ•â€ğŸ¦º",
  "ğŸ¦¥",
  "ğŸ¦¦",
  "ğŸ¦¨",
  "ğŸ¦©",
  "â˜ƒï¸",
  "ğŸ‰",
  "ğŸ²",
  "ğŸŒµ",
  "ğŸ„",
  "ğŸŒ²",
  "ğŸŒ³",
  "ğŸŒ´",
  "ğŸŒ¿",
  "â˜˜ï¸",
  "ğŸ€",
  "ğŸ",
  "ğŸ‹",
  "ğŸƒ",
  "ğŸ‚",
  "ğŸ",
  "ğŸ„",
  "ğŸŒ¾",
  "ğŸ’",
  "ğŸŒ·",
  "ğŸŒ¹",
  "ğŸ¥€",
  "ğŸŒº",
  "ğŸŒ¸",
  "ğŸŒ¼",
  "ğŸŒ»",
  "ğŸŒ",
  "ğŸŒ",
  "ğŸŒ",
  "ğŸŒ",
  "ğŸŒ",
  "ğŸ’«",
  "â­ï¸",
  "ğŸŒŸ",
  "âœ¨",
  "âš¡ï¸",
  "â˜„ï¸",
  "ğŸ’¥",
  "ğŸ”¥",
  "ğŸŒˆ",
  "â˜€ï¸",
  "ğŸŒ¤",
  "â›…ï¸",
  "â˜ï¸",
  "ğŸŒ¦",
  "ğŸŒ©",
  "ğŸŒ¨",
  "â„ï¸",
  "ğŸ’¨",
  "ğŸ’§",
  "ğŸ’¦",
  "â˜”ï¸",
  "â˜‚ï¸",
  "ğŸŒŠ",
  "ğŸ",
  "ğŸ",
  "ğŸ",
  "ğŸŠ",
  "ğŸ‹",
  "ğŸŒ",
  "ğŸ‰",
  "ğŸ‡",
  "ğŸ“",
  "ğŸˆ",
  "ğŸ’",
  "ğŸ‘",
  "ğŸ",
  "ğŸ¥­",
  "ğŸ¥¥",
  "ğŸ¥",
  "ğŸ…",
  "ğŸ†",
  "ğŸ¥‘",
  "ğŸ¥¦",
  "ğŸ¥’",
  "ğŸ¥¬",
  "ğŸŒ¶",
  "ğŸŒ½",
  "ğŸ¥•",
  "ğŸ¥”",
  "ğŸ ",
  "ğŸ¥",
  "ğŸ",
  "ğŸ¥–",
  "ğŸ¥¨",
  "ğŸ¥¯",
  "ğŸ§€",
  "ğŸ¥š",
  "ğŸ³",
  "ğŸ¥",
  "ğŸ¥“",
  "ğŸ¥©",
  "ğŸ—",
  "ğŸ–",
  "ğŸŒ­",
  "ğŸ”",
  "ğŸŸ",
  "ğŸ•",
  "ğŸ¥ª",
  "ğŸ¥™",
  "ğŸŒ®",
  "ğŸŒ¯",
  "ğŸ¥—",
  "ğŸ¥˜",
  "ğŸ¥«",
  "ğŸ",
  "ğŸœ",
  "ğŸ²",
  "ğŸ›",
  "ğŸ£",
  "ğŸ±",
  "ğŸ¥Ÿ",
  "ğŸ¤",
  "ğŸ™",
  "ğŸš",
  "ğŸ˜",
  "ğŸ¥",
  "ğŸ¥®",
  "ğŸ¥ ",
  "ğŸ¢",
  "ğŸ¡",
  "ğŸ§",
  "ğŸ¨",
  "ğŸ¦",
  "ğŸ¥§",
  "ğŸ°",
  "ğŸ‚",
  "ğŸ®",
  "ğŸ­",
  "ğŸ¬",
  "ğŸ«",
  "ğŸ¿",
  "ğŸ§‚",
  "ğŸ©",
  "ğŸª",
  "ğŸŒ°",
  "ğŸ¥œ",
  "ğŸ¯",
  "ğŸ¥›",
  "ğŸ¼",
  "â˜•ï¸",
  "ğŸµ",
  "ğŸ¥¤",
  "ğŸ¶",
  "ğŸº",
  "ğŸ»",
  "ğŸ¥‚",
  "ğŸ·",
  "ğŸ¥ƒ",
  "ğŸ¸",
  "ğŸ¹",
  "ğŸ¾",
  "ğŸ¥„",
  "ğŸ´",
  "ğŸ½",
  "ğŸ¥£",
  "ğŸ¥¡",
  "ğŸ¥¢",
  "ğŸ§„",
  "ğŸ§…",
  "ğŸ§‡",
  "ğŸ§†",
  "ğŸ§ˆ",
  "ğŸ¦ª",
  "ğŸ§ƒ",
  "ğŸ§‰",
  "ğŸ§Š",
  "âš½ï¸",
  "ğŸ€",
  "ğŸˆ",
  "âš¾ï¸",
  "ğŸ¥",
  "ğŸ",
  "ğŸ‰",
  "ğŸ¾",
  "ğŸ¥",
  "ğŸ±",
  "ğŸ“",
  "ğŸ¸",
  "ğŸ¥…",
  "ğŸ’",
  "ğŸ‘",
  "ğŸ¥",
  "ğŸ",
  "â›³ï¸",
  "ğŸ¹",
  "ğŸ£",
  "ğŸ¥Š",
  "ğŸ¥‹",
  "ğŸ½",
  "â›¸",
  "ğŸ¥Œ",
  "ğŸ›·",
  "ğŸ›¹",
  "ğŸ¿",
  "ğŸª",
  "ğŸ¤",
  "ğŸ§",
  "ğŸ¹",
  "ğŸ¥",
  "ğŸ·",
  "ğŸº",
  "ğŸ¸",
  "ğŸ»",
  "ğŸ²",
  "ğŸ¯",
  "ğŸ³",
  "ğŸ®",
  "ğŸ°",
  "ğŸ—º",
  "ğŸ—¿",
  "ğŸš—",
  "ğŸš•",
  "ğŸš™",
  "ğŸšŒ",
  "ğŸš",
  "ğŸ",
  "ğŸš“",
  "ğŸš‘",
  "ğŸš’",
  "ğŸš",
  "ğŸšš",
  "ğŸš›",
  "ğŸšœ",
  "ğŸ›´",
  "ğŸš²",
  "ğŸ›µ",
  "ğŸ",
  "ğŸš¨",
  "ğŸš”",
  "ğŸš",
  "ğŸš˜",
  "ğŸš–",
  "ğŸš¡",
  "ğŸš ",
  "ğŸšŸ",
  "ğŸšƒ",
  "ğŸš‹",
  "ğŸš",
  "ğŸš",
  "ğŸš„",
  "ğŸš…",
  "ğŸšˆ",
  "ğŸš‚",
  "ğŸš†",
  "ğŸš‡",
  "ğŸšŠ",
  "ğŸš‰",
  "âœˆï¸",
  "ğŸ›«",
  "ğŸ›¬",
  "ğŸ›©",
  "ğŸ’º",
  "ğŸ›°",
  "ğŸš€",
  "ğŸ›¸",
  "ğŸš",
  "ğŸ›¶",
  "â›µï¸",
  "ğŸš¤",
  "ğŸ›¥",
  "ğŸ›³",
  "â›´",
  "ğŸš¢",
  "âš“ï¸",
  "â›½ï¸",
  "ğŸš§",
  "ğŸ—¼",
  "ğŸ°",
  "ğŸ¯",
  "ğŸŸ",
  "ğŸ¡",
  "ğŸ¢",
  "ğŸ ",
  "â›²ï¸",
  "â›±",
  "ğŸ–",
  "ğŸ",
  "ğŸœ",
  "ğŸŒ‹",
  "â›°",
  "ğŸ”",
  "ğŸ—»",
  "ğŸ•",
  "â›ºï¸",
  "ğŸ ",
  "ğŸ¡",
  "ğŸ˜",
  "ğŸš",
  "ğŸ—",
  "ğŸ­",
  "ğŸ¢",
  "âŒšï¸",
  "ğŸ–²",
  "ğŸ•¹",
  "ğŸ—œ",
  "ğŸ’½",
  "ğŸ’¾",
  "ğŸ’¿",
  "ğŸ“€",
  "ğŸ“¼",
  "ğŸ“·",
  "ğŸ“¸",
  "ğŸ“¹",
  "ğŸ¥",
  "ğŸ“½",
  "ğŸ“",
  "â˜ï¸",
  "ğŸ“Ÿ",
  "ğŸ“ ",
  "ğŸ“º",
  "ğŸ“»",
  "ğŸ™",
  "ğŸš",
  "ğŸ›",
  "â±",
  "â²",
  "â°",
  "ğŸ•°",
  "âŒ›ï¸",
  "â³",
  "ğŸ“¡",
  "ğŸ”‹",
  "ğŸ”Œ",
  "ğŸ’¡",
  "ğŸ”¦",
  "ğŸ•¯",
  "ğŸ’",
  "âš–ï¸",
  "ğŸ”§",
  "ğŸ”¨",
  "âš’",
  "ğŸ› ",
  "â›",
  "ğŸ”©",
  "âš™ï¸",
  "â›“",
  "ğŸ›¡",
  "ğŸ§­",
  "ğŸ§±",
  "ğŸ”®",
  "ğŸ§¿",
  "ğŸ§¸",
  "ğŸ’ˆ",
  "âš—ï¸",
  "ğŸ”­",
  "ğŸ§°",
  "ğŸ§²",
  "ğŸ§ª",
  "ğŸ§«",
  "ğŸ§¬",
  "ğŸ§¯",
  "ğŸ”¬",
  "ğŸ§´",
  "ğŸ§µ",
  "ğŸ§¶",
  "ğŸ§·",
  "ğŸ§¹",
  "ğŸ§º",
  "ğŸ§»",
  "ğŸ§¼",
  "ğŸ§½",
  "ğŸ›",
  "ğŸ”‘",
  "ğŸ—",
  "ğŸšª",
  "ğŸ›‹",
  "ğŸ›",
  "ğŸ›Œ",
  "ğŸ–¼",
  "ğŸ›",
  "ğŸ§³",
  "ğŸ›’",
  "ğŸ",
  "ğŸˆ",
  "ğŸ",
  "ğŸ€",
  "ğŸŠ",
  "ğŸ‰",
  "ğŸ§¨",
  "ğŸ",
  "ğŸ®",
  "ğŸ",
  "ğŸ§§",
  "âœ‰ï¸",
  "ğŸ“¨",
  "ğŸ“¦",
  "ğŸ·",
  "ğŸ“«",
  "ğŸ“®",
  "ğŸ“¯",
  "ğŸ“‡",
  "ğŸ—ƒ",
  "ğŸ—³",
  "ğŸ—„",
  "ğŸ“‹",
  "ğŸ“",
  "ğŸ—‚",
  "ğŸ—",
  "ğŸ“°",
  "ğŸ““",
  "ğŸ“”",
  "ğŸ“’",
  "ğŸ“•",
  "ğŸ“—",
  "ğŸ“˜",
  "ğŸ“™",
  "ğŸ“š",
  "ğŸ“–",
  "ğŸ”–",
  "ğŸ”—",
  "ğŸ“",
  "ğŸ–‡",
  "ğŸ“",
  "ğŸ“",
  "ğŸ“Œ",
  "ğŸ“",
  "âœ‚ï¸",
  "ğŸ–Š",
  "âœ’ï¸",
  "ğŸ–",
  "ğŸ“",
  "âœï¸",
  "â¤ï¸",
  "ğŸ§¡",
  "ğŸ’›",
  "ğŸ’š",
  "ğŸ’™",
  "ğŸ’œ",
  "ğŸ–¤",
  "ğŸ”Š",
  "ğŸ””",
  "ğŸ“£",
  "ğŸ“¢",
  "ğŸ’ ",
];

const EMOJIS_USER = [
  "ğŸ˜€",
  "ğŸ˜",
  "ğŸ˜‚",
  "ğŸ¤£",
  "ğŸ˜ƒ",
  "ğŸ˜„",
  "ğŸ˜…",
  "ğŸ˜†",
  "ğŸ˜‰",
  "ğŸ˜Š",
  "ğŸ˜‹",
  "ğŸ˜",
  "ğŸ™‚",
  "ğŸ¤—",
  "ğŸ¤©",
  "ğŸ¤”",
  "ğŸ¤¨",
  "ğŸ˜",
  "ğŸ˜‘",
  "ğŸ˜¶",
  "ğŸ™„",
  "ğŸ˜",
  "ğŸ˜´",
  "ğŸ˜Œ",
  "ğŸ˜’",
  "ğŸ™ƒ",
  "ğŸ˜²",
  "ğŸ¤¯",
  "ğŸ˜¬",
  "ğŸ¥µ",
  "ğŸ¥¶",
  "ğŸ˜³",
  "ğŸ¤ª",
  "ğŸ¤ ",
  "ğŸ¤¡",
  "ğŸ¥³",
  "ğŸ¥´",
  "ğŸ¥º",
  "ğŸ§",
  "ğŸ¤“",
  "ğŸ˜ˆ",
  "ğŸ‘¿",
  "ğŸ‘¹",
  "ğŸ‘º",
  "ğŸ’€",
  "ğŸ‘»",
  "ğŸ‘½",
  "ğŸ¤–",
  "ğŸ˜º",
  "ğŸ˜¸",
  " ",
  "ğŸ˜¼",
  "ğŸ˜½",
  "ğŸ¶",
  "ğŸ±",
  "ğŸ­",
  "ğŸ¹",
  "ğŸ°",
  "ğŸ¦Š",
  "ğŸ¦",
  "ğŸ»",
  "ğŸ¼",
  "ğŸ¦˜",
  "ğŸ¦¡",
  "ğŸ¨",
  "ğŸ¯",
  "ğŸ¦",
  "ğŸ®",
  "ğŸ·",
  "ğŸ½",
  "ğŸ¸",
  "ğŸµ",
  "ğŸ™ˆ",
  "ğŸ™‰",
  "ğŸ™Š",
  "ğŸ’",
  "ğŸ”",
  "ğŸ§",
  "ğŸ¦",
  "ğŸ¤",
];
